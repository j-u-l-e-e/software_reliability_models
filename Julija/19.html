<!DOCTYPE html>
<html lang="lv">
<head>
    <title>Teksta modelis</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/style.css">
    <script src="../js/textmodel.js"></script>
    <script src="../js/util.js"></script>
    <script src="../js/papaparse.min.js"></script>
</head>
<body>

<h1>Teksta modelis</h1>
<button id="buttonAboutModel">Par Teksta modeli</button>

<div>
    <label for="inputOperandsTotalCount">Programatūras garums, <i>N</i>:</label>
    <input id="inputOperandsTotalCount" type="number" min="0" step="1" onblur="this.value = parseInt(this.value)">
</div>
<div>
    <label for="inputUnitsCount">Kopējais moduļu skaits,  <i>n</i>:</label>
    <input id="inputUnitsCount" type="number" min="0" step="1" onblur="this.value = parseInt(this.value)">
</div>
<div>
    <label for="inputInitialFoundErrorsCount">Sākotnējais atrasto kļūdu skaits, <i>B<sub>0</sub></i>:</label>
    <input id="inputInitialFoundErrorsCount" type="number" min="0" step="1" onblur="this.value = parseInt(this.value)">
</div>
<div>
    <table>
        <tr>
            <th>Koda garums moduļos</th>
            <th>Kļūdu skaits moduļos</th>
            <th>Moduļu testēšanas pakāpes</th>
        </tr>
        <tr>
            <td>
                <textarea id="textareaCodeLengths"></textarea>
            </td>
            <td>
                <textarea id="textareaErrorsCounts"></textarea>
            </td>
            <td>
                <textarea disabled="disabled" id="textareaTestCoverage"></textarea>
            </td>
        </tr>
    </table>
    <div>
        <input id="inputUnitsDataFile" type="file" accept=".csv,.doc"/>
    </div>
    <div>
        <button id="buttonCalculate">Aprēķināt</button>
    </div>
</div>

<p id="pAvgCodeLength">
<p id="pAvgErrorsCount">
<p id="pInitialErrorsCount">

    <!-- Put script after all DOM elements are initialized -->
    <script>
        var inputCodeLengthTotal = document.getElementById("inputOperandsTotalCount");
        var inputUnitsCount = document.getElementById("inputUnitsCount");
        var inputInitialFoundErrorsCount = document.getElementById("inputInitialFoundErrorsCount");
        var textareaCodeLengths = document.getElementById("textareaCodeLengths");
        var textareaErrorsCounts = document.getElementById("textareaErrorsCounts");
        var textareaTestCoverage = document.getElementById("textareaTestCoverage");
        var pAvgCodeLength = document.getElementById("pAvgCodeLength");
        var pAvgErrorsCount = document.getElementById("pAvgErrorsCount");
        var pInitialErrorsCount = document.getElementById("pInitialErrorsCount");
        var buttonCalculate = document.getElementById("buttonCalculate");
        var inputUnitsDataFile = document.getElementById("inputUnitsDataFile");
        var buttonAboutModel = document.getElementById("buttonAboutModel");

        var textModel = TextModel();

        buttonAboutModel.addEventListener("click", function () {
            var myWindow = window.open("about/19.html", "Teksta modelis", "width=300,height=500");
        });

        buttonCalculate.addEventListener("click", function (event) {
            // Parse model data
            var codeLengthTotal = parseInt(inputCodeLengthTotal.value);
            var unitsCount = parseInt(inputUnitsCount.value);
            var codeLengths = parseNaturalNonNullNumbers(textareaCodeLengths.value);
            var errorCounts = parseNaturalNonNullNumbers(textareaErrorsCounts.value);
            var initialFoundErrorsCount = parseNaturalNonNullNumbers(inputInitialFoundErrorsCount.value);

            try {
                textModel.setup(codeLengthTotal, unitsCount, codeLengths, errorCounts, initialFoundErrorsCount);
            } catch (e) {
                alert(e.message);
                return false;
            }

            // Data OK, show calculated data
            pAvgCodeLength.innerHTML = "Vidējais moduļu garums, Nvid: " + textModel.getAvgCodeLength();
            pAvgErrorsCount.innerHTML = "Vidējais kļūdu skaits, Bvid: " + textModel.getAvgErrorsCount();
            pInitialErrorsCount.innerHTML = "Sakumkļūdu skaits programmatūrā, B: " + textModel.getInitialErrorsCount();
            textareaTestCoverage.value = textModel.getTestCoverageString();
            return true;
        });

        inputUnitsDataFile.addEventListener("change", function (evt) {
            var unitsDataFile = evt.target.files[0];

            Papa.parse(unitsDataFile, {
                complete: function (results) {
                    if (results.errors.length == 0) { // data ok
                        var codeLengths = "";
                        var errorCounts = "";

                        if (results.data[0].length != 2) {
                            alert(".csv datnes struktūra neatbilst šablonām: [koda garums, kļūdu skaits]");
                            return false;
                        }

                        for (var i = 0; i < results.data.length; i++) {
                            if (results.data[i][0]) codeLengths += results.data[i][0] + "\n";
                            else codeLengths += 0 + "\n";
                            if (results.data[i][1]) errorCounts += results.data[i][1] + "\n";
                            else errorCounts += 0 + "\n";
                        }
                        // Remove \n in the end of strings
                        codeLengths = codeLengths.slice(0, codeLengths.length - 1);
                        errorCounts = errorCounts.slice(0, errorCounts.length - 1);

                        textareaCodeLengths.value = codeLengths;
                        textareaErrorsCounts.value = errorCounts;
                    }
                }
            });
        });

    </script>
</body>
</html>