<!DOCTYPE html>
<html lang="lv">
<head>
    <title>Veibula modelis</title>
    <meta charset="UTF-8">
    <script src="../js/weibullmodel.js"></script>
    <script src="../js/util.js"></script>
    <script src="../js/papaparse.min.js"></script>
</head>
<body>

<h1>Veibula modelis</h1>
<button id="buttonAboutModel">Par Veibula modeli</button>

<div>
    <label for="inputTimeCurr">Laiks prognozēšanai, t</label>
    <input id="inputTimeCurr" type="number" min="0" step="1" onblur="this.value = parseInt(this.value)">
</div>
<table>
    <tr>
        <th>Kļudu atklāšanas laiki</th>
    </tr>
    <tr>
        <td>
            <textarea id="textareaFailureTimes"></textarea>
        </td>
    </tr>
</table>
<div>
    <input id="inputFailuresDataFile" type="file" accept=".csv,.doc"/>
</div>
<label for="inputManualParameters">Patstavīgi izvēlēties parametru vērtības</label>
<input type="checkbox" id="inputManualParameters">
<div>
    <label for="inputScale">α</label>
    <input id="inputScale" type="number" min="0.001" step="0.001" disabled="disabled" onblur="this.value = Math.abs(this.value)">
    <label for="inputShape">β</label>
    <input id="inputShape" type="number" min="0.001" step="0.001" disabled="disabled" onblur="this.value = Math.abs(this.value)">
</div>
<div>
    <button id="buttonCalculate">Aprēķināt</button>
</div>

<p id="pReliability">
<p id="pFailureRate">
</body>
<script>
    var weibullModel = WeibullModel();
    var buttonAboutModel = document.getElementById("buttonAboutModel");
    var buttonCalculate = document.getElementById("buttonCalculate");
    var inputFailuresDataFile = document.getElementById("inputFailuresDataFile");
    var inputManualParameters = document.getElementById("inputManualParameters");
    var manualParameters = false;

    inputManualParameters.addEventListener("change", function () {
        manualParameters = !manualParameters;
        var inputScale = document.getElementById("inputScale");
        var inputShape = document.getElementById("inputShape");
        inputScale.disabled = !inputScale.disabled;
        inputShape.disabled = !inputShape.disabled;
    });

    buttonAboutModel.addEventListener("click", function () {
        var myWindow = window.open("about/8.html", "Veibula modelis", "width=300,height=500");
    });

    buttonCalculate.addEventListener("click", function (event) {
        // Parse model data
        var timeCurr = parseInt(document.getElementById("inputTimeCurr").value);
        var failureTimes = parseNaturalNonNullNumbers(document.getElementById("textareaFailureTimes").value);
        var scale = false;
        var shape = false;

        if (manualParameters) {
            scale = parseFloat(document.getElementById("inputScale").value);
            shape = parseFloat(document.getElementById("inputShape").value);
            if (!scale || !shape) {
                alert("α un β jābūt lielākiem par 0");
                return false;
            }
        }


        try {
            weibullModel.setup(failureTimes, timeCurr, scale, shape);
        } catch (e) {
            alert(e.message);
            return false;
        }

        // Data OK, show calculated data
        document.getElementById("pReliability").innerHTML = "Drošums, R(t): " + weibullModel.getReliability();
        document.getElementById("pFailureRate").innerHTML = "Atteiču intensitāte, λ(t): " + weibullModel.getFailureRate();
        if (!manualParameters) {
            document.getElementById("inputScale").value = weibullModel.getScale();
            document.getElementById("inputShape").value = weibullModel.getShape();
        }
        return true;
    });

    inputFailuresDataFile.addEventListener("change", function (evt) {
        var failuresDataFile = evt.target.files[0];

        Papa.parse(failuresDataFile, {
            delimiter: ",", // to avoid error "Unable to auto-detect delimiting character" when one column
            complete: function (results) {
                if (results.errors.length === 0) { // data ok
                    var failureTimes = "";

                    if (results.data[0].length !== 1) {
                        alert(".csv datnes struktūra neatbilst šablonām: [kļūdu atklāšanas laiks]");
                        return false;
                    }

                    for (var i = 0; i < results.data.length; i++) {
                        if (results.data[i][0]) failureTimes += results.data[i][0] + "\n";
                        else failureTimes += 0 + "\n";
                    }
                    // Remove \n in the end of strings
                    failureTimes = failureTimes.slice(0, failureTimes.length - 1);

                    document.getElementById("textareaFailureTimes").value = failureTimes;
                }
            }
        });
    });

</script>
</html>